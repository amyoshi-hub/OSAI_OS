まずlinuxのkernelをダウンロード
make defconfig
make
でbzImageを作る

initrafs　ディレクトリを作る
initを以下のコードにする

#include <unistd.h>
#include <stdio.h>

int main() {
    write(1, "HELLO from init\n", 16);
    execl("/bin/sh", "sh", NULL);
    perror("execl failed");
    return 1;
}
gcc -static -o init init.c
staticでbuild

そしてinitに改名

cd initrafs

//find . | cpio -o -H newc | gzip > ../initramfs.cpio.gz
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../initramfs.cpio.gz こっちが正しいかも

qemu-system-x86_64 -kernel arch/x86/boot/bzImage -initrd initramfs.cpio -append "root=/dev/ram0 console=ttyS0"
で起動ができたらOK

次にUSBにgrub-installのマニュアルに従っていれる

すると
sudo qemu-system-x86_64 -drive file=/dev/sda,format=raw -serial stdio
で起動できるようになる


qemu内で
└─$ qemu-system-x86_64 -kernel bzImage -initrd initramfs.cpio.gz -append "root=/dev/ram0 console=tty0"

serial
└─$ qemu-system-x86_64 -kernel bzImage -initrd initramfs.cpio.gz -append "root=/dev/ram0 console=ttyS0" -serial stdio


network
└─$ qemu-system-x86_64 -kernel bzImage -initrd initramfs.cpio.gz -append "console=tty0" -netdev user,id=mynet0 -device e1000,netdev=mynet0 -serial stdio

